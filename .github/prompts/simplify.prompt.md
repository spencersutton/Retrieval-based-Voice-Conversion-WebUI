---
mode: agent
model: GPT-4.1
---
Simplify and make this code more readable.
Reduce duplication where possible.
Ensure there are no functional changes.
Do not remove comments unless it is commented out code 
and only add comments if they improve clarity significantly.